<UserControl x:Class="MediaBackupTool.Views.Pages.VerificationPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="750" d:DesignWidth="950">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Margin="0,0,0,10">
            <TextBlock Text="File Verification" FontSize="24" FontWeight="Bold"/>
            <TextBlock Text="Independent verification by direct file comparison (byte-by-byte hash)"
                       Foreground="Gray" FontSize="12" Margin="0,5,0,0"/>
        </StackPanel>

        <!-- Controls -->
        <Border Grid.Row="1" Background="#F5F5F5" Padding="15" CornerRadius="6" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <!-- Start button - visible when not verifying -->
                    <Button Content="Start Verification" Command="{Binding StartVerificationCommand}"
                            Padding="20,10" Margin="0,0,10,0"
                            Background="#2196F3" Foreground="White" BorderThickness="0" FontWeight="SemiBold"
                            Visibility="{Binding IsVerifying, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"/>

                    <!-- Pause button - visible when verifying and not paused -->
                    <Button Content="Pause" Command="{Binding PauseVerificationCommand}"
                            Padding="20,10" Margin="0,0,10,0"
                            Visibility="{Binding IsVerifying, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <!-- Resume button - visible when paused -->
                    <Button Content="Resume" Command="{Binding ResumeVerificationCommand}"
                            Padding="20,10" Margin="0,0,10,0"
                            Background="#4CAF50" Foreground="White" BorderThickness="0"
                            Visibility="{Binding IsPaused, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <!-- Cancel button - visible when verifying -->
                    <Button Content="Cancel" Command="{Binding CancelVerificationCommand}"
                            Padding="20,10"
                            Visibility="{Binding IsVerifying, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>

                <!-- Navigation buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal"
                            Visibility="{Binding IsVerifying, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                    <Button Content="Back to Copy" Command="{Binding NavigateToCopyCommand}"
                            Padding="15,8" Margin="0,0,10,0"/>
                    <Button Content="View Duplicates" Command="{Binding NavigateToDuplicatesCommand}"
                            Padding="15,8"
                            Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Progress Section -->
        <GroupBox Grid.Row="2" Header="Verification Progress" Margin="0,0,0,15">
            <Grid Margin="15">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Status Header with Phase -->
                <Border Background="#E3F2FD" Padding="10" CornerRadius="4" Margin="0,0,0,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                            <TextBlock Text="{Binding StatusMessage}" FontWeight="SemiBold" FontSize="14"/>
                            <TextBlock Text="{Binding PhaseDescription}" Foreground="#1976D2" FontSize="11" Margin="0,2,0,0"/>
                        </StackPanel>
                        <Border Grid.Column="1" Background="#BBDEFB" Padding="8,4" CornerRadius="4" Margin="10,0"
                                VerticalAlignment="Center">
                            <TextBlock Text="{Binding EstimatedTimeRemaining}" Foreground="#1565C0" FontWeight="SemiBold"/>
                        </Border>
                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Elapsed: " Foreground="Gray" FontSize="11"/>
                            <TextBlock Text="{Binding ElapsedTime, StringFormat=hh\\:mm\\:ss}" FontWeight="SemiBold" FontSize="11"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Current Files Being Compared -->
                <Grid Grid.Row="1" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <TextBlock Text="Source File:" FontWeight="SemiBold" Foreground="#1976D2" FontSize="11"/>
                        <TextBlock Text="{Binding CurrentSourceFile}" TextTrimming="CharacterEllipsis"
                                   Foreground="Gray" FontFamily="Consolas" FontSize="11"
                                   ToolTip="{Binding CurrentSourceFile}"/>
                    </StackPanel>

                    <TextBlock Grid.Column="1" Text=" vs " VerticalAlignment="Center"
                               FontWeight="Bold" Margin="10,0" Foreground="#9E9E9E"/>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Destination File:" FontWeight="SemiBold" Foreground="#4CAF50" FontSize="11"/>
                        <TextBlock Text="{Binding CurrentDestFile}" TextTrimming="CharacterEllipsis"
                                   Foreground="Gray" FontFamily="Consolas" FontSize="11"
                                   ToolTip="{Binding CurrentDestFile}"/>
                    </StackPanel>
                </Grid>

                <!-- Current File Size -->
                <TextBlock Grid.Row="2" Margin="0,0,0,10" Foreground="Gray" FontSize="11">
                    <Run Text="Current file size: "/>
                    <Run Text="{Binding CurrentFileSize, Converter={StaticResource FileSizeConverter}, Mode=OneWay}"/>
                </TextBlock>

                <!-- Progress Bar -->
                <Grid Grid.Row="3" Margin="0,0,0,15">
                    <ProgressBar Value="{Binding Progress}" Height="30" Minimum="0" Maximum="100"/>
                    <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="SemiBold">
                        <Run Text="{Binding Progress, StringFormat={}{0:F1}}"/>
                        <Run Text="%"/>
                    </TextBlock>
                </Grid>

                <!-- Stats Grid -->
                <Grid Grid.Row="4" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Files Verified -->
                    <Border Background="#E8F5E9" Padding="12,8" CornerRadius="4" Margin="0,0,4,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Verified" FontSize="10" Foreground="#2E7D32" HorizontalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding FilesVerified, StringFormat={}{0:N0}}"
                                           FontSize="18" FontWeight="Bold" Foreground="#2E7D32"/>
                                <TextBlock Text="{Binding TotalFiles, StringFormat=' / {0:N0}'}"
                                           FontSize="11" Foreground="#81C784" VerticalAlignment="Bottom" Margin="0,0,0,1"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Files Matched -->
                    <Border Grid.Column="1" Background="#E3F2FD" Padding="12,8" CornerRadius="4" Margin="4,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Matched" FontSize="10" Foreground="#1976D2" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding FilesMatched, StringFormat={}{0:N0}}"
                                       FontSize="18" FontWeight="Bold" Foreground="#1976D2" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Files Mismatched -->
                    <Border Grid.Column="2" Background="#FFEBEE" Padding="12,8" CornerRadius="4" Margin="4,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Mismatched" FontSize="10" Foreground="#C62828" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding FilesMismatched, StringFormat={}{0:N0}}"
                                       FontSize="18" FontWeight="Bold" Foreground="#C62828" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Files Skipped -->
                    <Border Grid.Column="3" Background="#ECEFF1" Padding="12,8" CornerRadius="4" Margin="4,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Skipped" FontSize="10" Foreground="#546E7A" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding FilesSkipped, StringFormat={}{0:N0}}"
                                       FontSize="18" FontWeight="Bold" Foreground="#546E7A" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Errors -->
                    <Border Grid.Column="4" Background="#FFF3E0" Padding="12,8" CornerRadius="4" Margin="4,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Errors" FontSize="10" Foreground="#E65100" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding ErrorCount, StringFormat={}{0:N0}}"
                                       FontSize="18" FontWeight="Bold" Foreground="#E65100" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Speed -->
                    <Border Grid.Column="5" Background="#F3E5F5" Padding="12,8" CornerRadius="4" Margin="4,0,0,0">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="Speed" FontSize="10" Foreground="#7B1FA2" HorizontalAlignment="Center"/>
                            <TextBlock FontSize="18" FontWeight="Bold" Foreground="#7B1FA2" HorizontalAlignment="Center">
                                <Run Text="{Binding MbPerSecond, StringFormat={}{0:F1}}"/>
                                <Run Text=" MB/s" FontSize="10"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Bytes Progress -->
                <TextBlock Grid.Row="5" Foreground="Gray" FontSize="11">
                    <Run Text="Data verified: "/>
                    <Run Text="{Binding BytesVerified, Converter={StaticResource FileSizeConverter}, Mode=OneWay}"/>
                    <Run Text=" / "/>
                    <Run Text="{Binding TotalBytes, Converter={StaticResource FileSizeConverter}, Mode=OneWay}"/>
                    <Run Text="  (reading both source and destination files)"/>
                </TextBlock>
            </Grid>
        </GroupBox>

        <!-- Results Section -->
        <GroupBox Grid.Row="3" Header="Verification Results">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Result Summary -->
                <Border Margin="0,0,0,10"
                        Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="#E8F5E9"/>
                            <Setter Property="Padding" Value="15"/>
                            <Setter Property="CornerRadius" Value="4"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding VerificationSuccessful}" Value="False">
                                    <Setter Property="Background" Value="#FFEBEE"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock VerticalAlignment="Center" FontSize="20" Margin="0,0,10,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="&#x2714;"/>
                                    <Setter Property="Foreground" Value="#2E7D32"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding VerificationSuccessful}" Value="False">
                                            <Setter Property="Text" Value="&#x2718;"/>
                                            <Setter Property="Foreground" Value="#C62828"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <StackPanel>
                            <TextBlock FontWeight="SemiBold" FontSize="14">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="All files verified successfully!"/>
                                        <Setter Property="Foreground" Value="#2E7D32"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding VerificationSuccessful}" Value="False">
                                                <Setter Property="Text" Value="Verification completed with issues"/>
                                                <Setter Property="Foreground" Value="#C62828"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBlock Foreground="Gray" FontSize="11">
                                <Run Text="Total verified: "/>
                                <Run Text="{Binding FilesMatched, StringFormat={}{0:N0}, Mode=OneWay}"/>
                                <Run Text=" files in "/>
                                <Run Text="{Binding ElapsedTime, StringFormat=hh\\:mm\\:ss, Mode=OneWay}"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Mismatches List -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding Mismatches}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column"
                          RowHeight="32"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling">
                    <DataGrid.Columns>
                        <!-- File name -->
                        <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="150">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="ToolTip" Value="{Binding DestPath}"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Size -->
                        <DataGridTextColumn Header="Size" Binding="{Binding FileSizeFormatted}" Width="70">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Reason -->
                        <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#C62828"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Renamed indicator -->
                        <DataGridTextColumn Header="Renamed" Binding="{Binding RenameInfo}" Width="120">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#FF9800"/>
                                    <Setter Property="FontSize" Value="10"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="ToolTip" Value="{Binding OriginalPlannedPath}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Source Path with folder button -->
                        <DataGridTemplateColumn Header="Source" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding SourcePath}" TextTrimming="CharacterEllipsis"
                                                   FontFamily="Consolas" FontSize="10" VerticalAlignment="Center"
                                                   ToolTip="{Binding SourcePath}" Margin="0,0,5,0"/>
                                        <Button Grid.Column="1" Content="Folder" Padding="4,2" FontSize="10"
                                                Click="OpenSourceFolder_Click" ToolTip="Open source folder in Explorer"
                                                Margin="0,0,2,0"/>
                                        <Button Grid.Column="2" Content="View" Padding="4,2" FontSize="10"
                                                Click="OpenSourceFile_Click" ToolTip="Open source file in default viewer"/>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Dest Path with folder button -->
                        <DataGridTemplateColumn Header="Destination" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding DestPath}" TextTrimming="CharacterEllipsis"
                                                   FontFamily="Consolas" FontSize="10" VerticalAlignment="Center"
                                                   ToolTip="{Binding DestPath}" Margin="0,0,5,0"/>
                                        <Button Grid.Column="1" Content="Folder" Padding="4,2" FontSize="10"
                                                Click="OpenDestFolder_Click" ToolTip="Open destination folder in Explorer"
                                                Margin="0,0,2,0"/>
                                        <Button Grid.Column="2" Content="View" Padding="4,2" FontSize="10"
                                                Click="OpenDestFile_Click" ToolTip="Open destination file in default viewer"/>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Empty state -->
                <Border Grid.Row="1" Background="#FAFAFA" CornerRadius="4"
                        Visibility="{Binding Mismatches.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=Invert}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="No mismatches detected" FontSize="16" Foreground="#9E9E9E"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="All verified files match their source files perfectly"
                                   Foreground="#BDBDBD" FontSize="12" Margin="0,5,0,0"
                                   HorizontalAlignment="Center"
                                   Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <TextBlock Text="Start verification to compare copied files with their sources"
                                   Foreground="#BDBDBD" FontSize="12" Margin="0,5,0,0"
                                   HorizontalAlignment="Center"
                                   Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"/>
                    </StackPanel>
                </Border>
            </Grid>
        </GroupBox>

        <!-- Info Footer -->
        <Border Grid.Row="4" Background="#E3F2FD" Padding="10" CornerRadius="4" Margin="0,15,0,0">
            <TextBlock TextWrapping="Wrap" Foreground="#1565C0" FontSize="11">
                <Run FontWeight="SemiBold">How it works:</Run>
                <Run Text=" This verification computes SHA-256 hashes for both source and destination files independently, then compares them. "/>
                <Run Text="This is completely separate from the original scan hashes and provides independent verification that copies are identical to their sources. "/>
                <Run Text="Effective read throughput is 2x the shown speed since both files are read."/>
            </TextBlock>
        </Border>
    </Grid>
</UserControl>
